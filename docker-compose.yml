services:
  app:
    image: 'jc21/nginx-proxy-manager:latest'
    container_name: npm-app
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - '${NPM_HTTP_PORT:-80}:80' # Public HTTP Port
      - '${NPM_HTTPS_PORT:-443}:443' # Public HTTPS Port
      - '${NPM_ADMIN_PORT:-8181}:81' # Admin Web Port
    environment:
      TZ: "${TZ}"
      DB_MYSQL_HOST: "db"
      DB_MYSQL_PORT: 3306
      DB_MYSQL_USER: "${NPM_DB_USER}"
      DB_MYSQL_PASSWORD: "${NPM_DB_PASSWORD}"
      DB_MYSQL_NAME: "${NPM_DB_NAME}"
    volumes:
      - ./data:/data
      - ./letsencrypt:/etc/letsencrypt
    depends_on:
      - db
    healthcheck:
      test: ["CMD", "/usr/bin/check-health"]
      interval: 10s
      timeout: 3s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  db:
    image: 'jc21/mariadb-aria:latest'
    container_name: npm-db
    restart: unless-stopped
    env_file:
      - .env
    environment:
      MYSQL_ROOT_PASSWORD: '${NPM_DB_ROOT_PASSWORD}'
      MYSQL_DATABASE: '${NPM_DB_NAME}'
      MYSQL_USER: '${NPM_DB_USER}'
      MYSQL_PASSWORD: '${NPM_DB_PASSWORD}'
      MARIADB_AUTO_UPGRADE: '1'
    volumes:
      - ./mysql:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  goaccess:
    image: 'justsky/goaccess-for-nginxproxymanager:latest'
    container_name: npm-goaccess
    restart: unless-stopped
    profiles:
      - analytics
    env_file:
      - .env
    depends_on:
      - app
    environment:
      TZ: "${TZ}"
      SKIP_ARCHIVED_LOGS: "False"
    volumes:
      - ./data/logs:/opt/log:ro
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -q --spider http://localhost:7880 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"